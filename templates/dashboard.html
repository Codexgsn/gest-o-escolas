{% extends "base.html" %}

{% block title %}Dashboard - Estat√≠sticas Gerais{% endblock %}

{% block content %}
<div class="container dashboard-container">
    <div class="dashboard-header">
        <div class="dashboard-header-content">
            <div class="dashboard-title">
                <h1>üìä Dashboard de Estat√≠sticas</h1>
                <p class="dashboard-subtitle">Vis√£o geral completa do sistema de reservas</p>
            </div>
            <div class="dashboard-actions">
                <a href="{{ url_for('admin') if current_user.is_admin else url_for('reservas') }}" class="btn-voltar">
                    ‚Üê Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Cards de Estat√≠sticas Principais -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon">üè¢</div>
            <div class="stat-content">
                <h3 id="total-salas">{{ total_salas }}</h3>
                <p>Total de Salas</p>
            </div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <h3 id="total-usuarios">{{ total_usuarios }}</h3>
                <p>Usu√°rios Cadastrados</p>
            </div>
        </div>
        
        <div class="stat-card info">
            <div class="stat-icon">üìÖ</div>
            <div class="stat-content">
                <h3 id="total-reservas">{{ total_reservas }}</h3>
                <p>Total de Reservas</p>
            </div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-icon">üìã</div>
            <div class="stat-content">
                <h3 id="reservas-hoje">{{ reservas_hoje }}</h3>
                <p>Reservas Hoje</p>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos e An√°lises -->
    <div class="charts-grid">
        <!-- Gr√°fico de Reservas por Per√≠odo -->
        <div class="chart-card">
            <h3>üìä Reservas por Per√≠odo</h3>
            <div class="chart-container">
                <canvas id="periodoChart"></canvas>
            </div>
            <div class="chart-stats">
                <div class="chart-stat">
                    <span class="stat-label">Manh√£</span>
                    <span class="stat-value">{{ reservas_manha }}</span>
                </div>
                <div class="chart-stat">
                    <span class="stat-label">Tarde</span>
                    <span class="stat-value">{{ reservas_tarde }}</span>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Reservas dos √öltimos 7 Dias -->
        <div class="chart-card">
            <h3>üìà Reservas dos √öltimos 7 Dias</h3>
            <div class="chart-container">
                <canvas id="ultimos7DiasChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tabelas de Rankings -->
    <div class="rankings-grid">
        <!-- Top 5 Salas Mais Reservadas -->
        <div class="ranking-card">
            <h3>üèÜ Top 5 Salas Mais Reservadas</h3>
                    <div class="ranking-table">
            <table id="salas-ranking">
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>Sala</th>
                        <th>Total de Reservas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sala, total in salas_mais_reservadas %}
                    <tr>
                        <td class="position">
                            {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td>{{ sala }}</td>
                        <td class="total">{{ total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>

        <!-- Top 5 Professores que Mais Reservam -->
        <div class="ranking-card">
            <h3>üë®‚Äçüè´ Top 5 Professores que Mais Reservam</h3>
                    <div class="ranking-table">
            <table id="professores-ranking">
                <thead>
                    <tr>
                        <th>Posi√ß√£o</th>
                        <th>Professor</th>
                        <th>Total de Reservas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for professor, total in professores_mais_reservam %}
                    <tr>
                        <td class="position">
                            {% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}
                        </td>
                        <td>{{ professor }}</td>
                        <td class="total">{{ total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        </div>
    </div>

    <!-- Salas Dispon√≠veis Hoje -->
    <div class="availability-section">
        <h3>‚úÖ Salas Dispon√≠veis Hoje ({{ hoje.strftime('%d/%m/%Y') }})</h3>
        {% if salas_disponiveis_hoje %}
        <div class="available-rooms">
            {% for sala in salas_disponiveis_hoje %}
            <div class="room-badge available">
                <span class="room-name">{{ sala.nome }}</span>
                <span class="room-capacity">{{ sala.capacidade }} lugares</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-availability">Todas as salas est√£o reservadas para hoje.</p>
        {% endif %}
    </div>

    <!-- Top Salas Reservadas Hoje -->
    {% if top_salas_hoje %}
    <div class="today-section">
        <h3>üî• Salas Mais Reservadas Hoje</h3>
        <div class="today-rooms">
            {% for sala, reservas in top_salas_hoje %}
            <div class="today-room">
                <span class="room-name">{{ sala }}</span>
                <span class="reservas-count">{{ reservas }} reserva{{ 's' if reservas > 1 else '' }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Gr√°fico de Reservas por M√™s -->
    <div class="monthly-chart-card">
        <h3>üìÖ Reservas por M√™s (√öltimos 6 Meses)</h3>
        <div class="chart-container">
            <canvas id="mensalChart"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Vari√°veis globais para os gr√°ficos
let periodoChart, ultimos7DiasChart, mensalChart;

// Fun√ß√£o para atualizar o dashboard em tempo real
function atualizarDashboard() {
    fetch('/dashboard/atualizar')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            try {
                // Verificar se os dados est√£o completos
                if (!data || typeof data !== 'object') {
                    console.error('Dados inv√°lidos recebidos:', data);
                    return;
                }
                
                // Atualizar estat√≠sticas principais
                if (document.getElementById('total-salas')) {
                    document.getElementById('total-salas').textContent = data.total_salas || 0;
                }
                if (document.getElementById('total-usuarios')) {
                    document.getElementById('total-usuarios').textContent = data.total_usuarios || 0;
                }
                if (document.getElementById('total-reservas')) {
                    document.getElementById('total-reservas').textContent = data.total_reservas || 0;
                }
                if (document.getElementById('reservas-hoje')) {
                    document.getElementById('reservas-hoje').textContent = data.reservas_hoje || 0;
                }
                
                // Atualizar gr√°fico de per√≠odo
                if (periodoChart && data.reservas_manha !== undefined && data.reservas_tarde !== undefined) {
                    periodoChart.data.datasets[0].data = [data.reservas_manha || 0, data.reservas_tarde || 0];
                    periodoChart.update();
                }
                
                // Atualizar gr√°fico de linha (7 dias)
                if (ultimos7DiasChart && Array.isArray(data.reservas_ultimos_7_dias)) {
                    const labels = data.reservas_ultimos_7_dias.map(r => r.data || '');
                    const values = data.reservas_ultimos_7_dias.map(r => r.total || 0);
                    ultimos7DiasChart.data.labels = labels;
                    ultimos7DiasChart.data.datasets[0].data = values;
                    ultimos7DiasChart.update();
                }
                
                // Atualizar gr√°fico mensal
                if (mensalChart && Array.isArray(data.reservas_por_mes)) {
                    const labels = data.reservas_por_mes.map(r => r.mes || '');
                    const values = data.reservas_por_mes.map(r => r.total || 0);
                    mensalChart.data.labels = labels;
                    mensalChart.data.datasets[0].data = values;
                    mensalChart.update();
                }
                
                // Atualizar tabelas de ranking
                if (Array.isArray(data.salas_mais_reservadas)) {
                    atualizarTabelaRanking('salas-ranking', data.salas_mais_reservadas, 'nome', 'total');
                }
                if (Array.isArray(data.professores_mais_reservam)) {
                    atualizarTabelaRanking('professores-ranking', data.professores_mais_reservam, 'nome', 'total');
                }
                
                // Atualizar salas dispon√≠veis
                if (Array.isArray(data.salas_disponiveis_hoje)) {
                    atualizarSalasDisponiveis(data.salas_disponiveis_hoje);
                }
                
                // Atualizar top salas hoje
                if (Array.isArray(data.top_salas_hoje)) {
                    atualizarTopSalasHoje(data.top_salas_hoje);
                }
            } catch (error) {
                console.error('Erro ao processar dados do dashboard:', error);
            }
        })
        .catch(error => {
            console.error('Erro ao atualizar dashboard:', error);
            // Tentar novamente em 5 segundos em caso de erro
            setTimeout(atualizarDashboard, 5000);
        });
}

// Fun√ß√£o para atualizar tabelas de ranking
function atualizarTabelaRanking(tableId, data, nomeField, totalField) {
    try {
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (!tbody) {
            console.warn(`Tbody n√£o encontrado para tabela: ${tableId}`);
            return;
        }
        
        if (!Array.isArray(data)) {
            console.warn(`Dados inv√°lidos para tabela ${tableId}:`, data);
            return;
        }
        
        tbody.innerHTML = '';
        data.forEach((item, index) => {
            if (!item || typeof item !== 'object') {
                console.warn(`Item inv√°lido na posi√ß√£o ${index}:`, item);
                return;
            }
            
            const tr = document.createElement('tr');
            const position = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : index + 1;
            const nome = item[nomeField] || 'N/A';
            const total = item[totalField] || 0;
            
            tr.innerHTML = `
                <td class="position">${position}</td>
                <td>${nome}</td>
                <td class="total">${total}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error(`Erro ao atualizar tabela ${tableId}:`, error);
    }
}

// Fun√ß√£o para atualizar salas dispon√≠veis
function atualizarSalasDisponiveis(salas) {
    try {
        const container = document.querySelector('.available-rooms');
        if (!container) {
            console.warn('Container de salas dispon√≠veis n√£o encontrado');
            return;
        }
        
        if (!Array.isArray(salas)) {
            console.warn('Dados de salas dispon√≠veis inv√°lidos:', salas);
            return;
        }
        
        if (salas.length === 0) {
            container.innerHTML = '<div class="no-availability">Nenhuma sala dispon√≠vel hoje</div>';
        } else {
            container.innerHTML = salas.map(sala => {
                if (!sala || typeof sala !== 'object') {
                    console.warn('Sala inv√°lida:', sala);
                    return '';
                }
                return `
                    <div class="room-badge">
                        <div class="room-name">${sala.nome || 'N/A'}</div>
                        <div class="room-capacity">${sala.capacidade || 0} lugares</div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Erro ao atualizar salas dispon√≠veis:', error);
    }
}

// Fun√ß√£o para atualizar top salas hoje
function atualizarTopSalasHoje(salas) {
    try {
        const container = document.querySelector('.today-rooms');
        if (!container) {
            console.warn('Container de top salas hoje n√£o encontrado');
            return;
        }
        
        if (!Array.isArray(salas)) {
            console.warn('Dados de top salas hoje inv√°lidos:', salas);
            return;
        }
        
        if (salas.length === 0) {
            container.innerHTML = '<div class="no-availability">Nenhuma sala reservada hoje</div>';
        } else {
            container.innerHTML = salas.map(sala => {
                if (!sala || typeof sala !== 'object') {
                    console.warn('Sala inv√°lida:', sala);
                    return '';
                }
                const reservas = sala.reservas_hoje || 0;
                return `
                    <div class="today-room">
                        <div class="room-name">${sala.nome || 'N/A'}</div>
                        <div class="reservas-count">${reservas} reserva${reservas > 1 ? 's' : ''}</div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Erro ao atualizar top salas hoje:', error);
    }
}

// Inicializar gr√°ficos
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Gr√°fico de Reservas por Per√≠odo (Pizza)
        const periodoCtx = document.getElementById('periodoChart');
        if (!periodoCtx) {
            console.warn('Canvas periodoChart n√£o encontrado');
            return;
        }
        
        periodoChart = new Chart(periodoCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Manh√£', 'Tarde'],
            datasets: [{
                data: [{{ reservas_manha }}, {{ reservas_tarde }}],
                backgroundColor: ['#3498db', '#e74c3c'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
    
        // Gr√°fico de Reservas dos √öltimos 7 Dias (Linha)
        const ultimos7DiasCtx = document.getElementById('ultimos7DiasChart');
        if (!ultimos7DiasCtx) {
            console.warn('Canvas ultimos7DiasChart n√£o encontrado');
            return;
        }
        
        ultimos7DiasChart = new Chart(ultimos7DiasCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: [
                                 {% for data, total in reservas_ultimos_7_dias %}
                 '{{ data.strftime("%d/%m") if data and data is not string else (data if data else "") }}'{% if not loop.last %},{% endif %}
                 {% endfor %}
            ],
            datasets: [{
                label: 'Reservas',
                data: [
                    {% for data, total in reservas_ultimos_7_dias %}
                    {{ total }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
        // Gr√°fico de Reservas por M√™s (Barras)
        const mensalCtx = document.getElementById('mensalChart');
        if (!mensalCtx) {
            console.warn('Canvas mensalChart n√£o encontrado');
            return;
        }
        
        mensalChart = new Chart(mensalCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: [
                {% for mes, total in reservas_por_mes %}
                '{{ mes }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Reservas',
                data: [
                    {% for mes, total in reservas_por_mes %}
                    {{ total }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(52, 152, 219, 0.8)',
                borderColor: '#3498db',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
        // Configurar atualiza√ß√£o autom√°tica a cada 30 segundos
        setInterval(atualizarDashboard, 30000);
        
        // Atualizar tamb√©m quando a p√°gina ganhar foco (usu√°rio retorna √† aba)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                atualizarDashboard();
            }
        });
        
        // Atualizar quando o usu√°rio fizer scroll para o topo (indicando interesse)
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop < lastScrollTop && scrollTop < 100) {
                atualizarDashboard();
            }
            lastScrollTop = scrollTop;
        });
        
    } catch (error) {
        console.error('Erro ao inicializar gr√°ficos do dashboard:', error);
        // Tentar inicializar novamente em 2 segundos
        setTimeout(() => {
            document.dispatchEvent(new Event('DOMContentLoaded'));
        }, 2000);
    }
});
</script>
{% endblock %}
